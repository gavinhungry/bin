#!/bin/bash

set -eo pipefail
shopt -s nullglob

source $(dirname "${BASH_SOURCE[0]}")/.abash/abash.sh

SCUP_DIR="/run/scup"
SERVICES=()

[ -d "$SCUP_DIR" ] || exit

for MARKER in "$SCUP_DIR"/*.service; do
  SERVICE=$(basename "$MARKER")

  if systemctl is-active --quiet "$SERVICE"; then
    MARKER_TIME=$(stat -c %Y "$MARKER")
    START_TIME_STR=$(systemctl show -p ActiveEnterTimestamp --value "$SERVICE" 2>/dev/null || true)

    if [[ -n "$START_TIME_STR" && "$START_TIME_STR" != "n/a" ]]; then
      SERVICE_TIME=$(date -d "$START_TIME_STR" +%s 2>/dev/null || echo 0)

      if [[ "$SERVICE_TIME" -gt "$MARKER_TIME" ]]; then
        arge dry-run || sudo rm "$MARKER"
        continue
      fi
    fi

    SERVICES+=("$SERVICE")
  else
    arge dry-run || sudo rm "$MARKER"
  fi
done

[ ${#SERVICES[@]} -gt 0 ] || exit 0

arge dry-run || systemctl daemon-reload

for SERVICE in "${SERVICES[@]}"; do
  echo "$SERVICE"
  if ! arge dry-run; then
    systemctl restart "$SERVICE"
    sudo rm "$SCUP_DIR/$SERVICE"
  fi
done
