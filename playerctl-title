#!/bin/bash

source $(dirname "${BASH_SOURCE[0]}")/.abash/abash.sh

MAX_LENGTH=$(arg max-length 0)
LABEL=$(arg label)
DELIMITER=$(arg delimiter -)

TITLE=$(rhythmbox-client --no-start --print-playing-format '%st')
[ -z "$TITLE" ] && TITLE=$(rhythmbox-client --no-start --print-playing-format "%ta $DELIMITER %tt")
TITLE=${TITLE# ${DELIMITER} }

if [ -z "$TITLE" ]; then
  TITLE=$(playerctl -p $PLAYER_NAME metadata -f "{{artist}} $DELIMITER {{title}}" 2> /dev/null)
  TITLE=${TITLE# ${DELIMITER} }

  if [ "$TITLE" = 'YouTube Music' ]; then
    URL=$(playerctl -p $PLAYER_NAME metadata -f '{{xesam:url}}')
    TITLE=$(youtube-title "$URL")
  fi

  TITLE=${TITLE// x / & }
  TITLE=$(echo "$TITLE" | sed -r 's/^[0-9]*.?\s+//')
fi

[[ "$TITLE" != *" $DELIMITER ("* ]] && TITLE=${TITLE%% (*}
[[ "$TITLE" != *" $DELIMITER ["* ]] && TITLE=${TITLE%% [*}
[[ "$TITLE" != *" $DELIMITER |"* ]] && TITLE=${TITLE%% |*}

if [ -z "$TITLE" ]; then
  arge zwsp && echo -n "â€‹" # zero-width space for Xfce genmon
  exit 1
fi

[ $MAX_LENGTH -gt 0 -a ${#TITLE} -gt $MAX_LENGTH ] && TITLE="${TITLE::$MAX_LENGTH} ..."

[ -n "$LABEL" ] && echo -n "$LABEL "
echo $TITLE
