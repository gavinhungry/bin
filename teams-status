#!/bin/bash

TEAMS=/usr/share/teams/teams
TEAMS_DIR="${XDG_CONFIG_HOME}/Microsoft/Teams"
TEAMS_LOG_FILE="${TEAMS_DIR}"/logs.txt
TEAMS_STORAGE_FILE="${TEAMS_DIR}"/storage.json
TEAMS_STATUS_FILE=${XDG_CACHE_HOME}/teams-status

if [ "$1" == '--watch' ]; then
  mkdir -p "$TEAMS_DIR"

  [ ! -e "$TEAMS_LOG_FILE" ] && touch "$TEAMS_LOG_FILE"
  [ ! -e "$TEAMS_STORAGE_FILE" ] && touch "$TEAMS_STORAGE_FILE"
  [ ! -e "$TEAMS_STATUS_FILE" ] && echo 'unknown' > "$TEAMS_STATUS_FILE"

  surveil "$TEAMS_LOG_FILE" "$TEAMS_STORAGE_FILE" "$TEAMS_STATUS_FILE" teams-status
  exit
fi

if ! pidof -q $TEAMS; then
  echo 'offline'
  exit 1
fi

APP_STATES=$(jq -r '.appStates.states' "$TEAMS_STORAGE_FILE")
LAST_STATE=${APP_STATES##*,}

WEB_APP_STATES=$(jq -r '.webAppStates.states' "$TEAMS_STORAGE_FILE")
LAST_WEB_APP_STATE=${WEB_APP_STATES##*,}

if [ \
  "$LAST_STATE" == 'Quitting' -o \
  "$LAST_WEB_APP_STATE" == 'Disconnected' -o \
  "$LAST_WEB_APP_STATE" == 'Offline' -o \
  "$LAST_WEB_APP_STATE" == 'Unloaded' \
]; then
  echo 'offline'
  exit
fi

cat "$TEAMS_STATUS_FILE"
