#!/bin/bash

source $(dirname "${BASH_SOURCE[0]}")/abash/abash.sh

PROFILE_NAME=$(fnfarg)
PROFILE_DIR=${HOME}/.rdp
PROFILE=$(readlink -f ${PROFILE_DIR}/${PROFILE_NAME:-default})

[ -f "$PROFILE" ] || die 'profile not found'

source "$PROFILE"

WINDOW_TITLE="${RDP_TITLE:-$RDP_SERVER} - Remote Desktop"

if [ "$RDP_NMB" == "1" ]; then
  RDP_SERVER=$(nmbip "$RDP_SERVER")
fi

(
  for WINDOW_ID in $(timeout 10s xdotool search --sync --name "^${WINDOW_TITLE}$"); do
    xseticon -id $WINDOW_ID "$RDP_ICON_PATH"
  done
) &

exec rdesktop -T "$WINDOW_TITLE" $RDP_SERVER -u ${RDP_USER:-${USER}} -d ${RDP_DOMAIN:-''} -p "$RDP_PASSWORD" -a ${RDP_DEPTH:-24} -x ${RDP_EXP:-0x80} -g ${RDP_GEOMETRY:-1200x800}
