#!/bin/bash

source $(dirname "${BASH_SOURCE[0]}")/.abash/abash.sh
echo

FETCH_IGNORE__DISK=('Msft Virtual Disk')
FETCH_IGNORE__GPU=(
  'Microsoft Basic Render Driver'
  'Vendor 1234 Device 1111'
  'llvmpipe'
)
FETCH_IGNORE__UCODE=('0xffffffff')

output_fetch() {
  local COLOR=$1; shift
  local LABEL=$1; shift
  local OUTPUT="$@"

  if includes FETCH_IGNORE__$LABEL "$OUTPUT"; then
    return
  fi

  if [ -n "$OUTPUT" ]; then
    color bold $COLOR
    printf "%7s" $LABEL
    color end
    echo -n ' '
    echo "$OUTPUT"
  fi
}

HOST=$(grep ^PRETTY_HOSTNAME= /etc/machine-info 2> /dev/null | cut -d= -f2)
if [ -z "$HOST" ]; then
  HOST=$(hostname)
  HOST="${HOST^}"
fi

output_fetch white HOST $HOST

output_fetch black OS \
  $(grep ^PRETTY_NAME= /etc/os-release 2> /dev/null | cut -d'"' -f2)

KERNEL=$(uname -sr)
KERNEL_M=$(uname -m)
[[ $KERNEL == *[.-]"$KERNEL_M" ]] || KERNEL="${KERNEL} ${KERNEL_M}"

output_fetch black KERNEL $KERNEL

output_fetch black WIN $(win-ver)
output_fetch black WSL $(wsl-ver)
output_fetch purple CPU $(cpu)
output_fetch purple NPU $(npu)
output_fetch green GPU $(gpu-glx || gpu)
output_fetch yellow MEM $(mem)

echo "$(disk)" | while IFS= read -r DISK; do
  output_fetch cyan DISK "$DISK"
done

output_fetch blue MODEL $(model)
output_fetch red BIOS $(bios)
output_fetch red UCODE $(ucode)

echo
