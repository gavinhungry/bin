#!/bin/bash

set -euo pipefail

source $(dirname "${BASH_SOURCE[0]}")/abash/abash.sh
([ $# -eq 0 ] || arge help) && usage '[options] PKGNAME [PKGNAME...]

  --testing, -t    fetch from [testing] repository
  --trunk, -k      fetch trunk
  --pkgbuild, -p   only fetch PKGBUILD and supporting files
  --help, -h       this message
'

export GNUPGHOME=/etc/pacman.d/gnupg

ARCH_DEVEL="$HOME/devel/arch"
ABS_DEVEL="$ARCH_DEVEL/abs"
AUR_DEVEL="$ARCH_DEVEL/aur"

[ -d "$ABS_DEVEL" ] || mkdir -p "$ABS_DEVEL"
[ -d "$AUR_DEVEL" ] || mkdir -p "$AUR_DEVEL"

GIT_URL='git://git.archlinux.org/svntogit'
AUR_URL="https://aur.archlinux.org"
AUR_RPC="$AUR_URL/rpc.php?v=5&type"

getAbsPkgbuild() {
  local PKG=$(expac -S '%e' $1)
  [ "$PKG" == '(null)' ] && PKG=$1

  local TMP=$(tmpdir "$PKG")
  cd "$TMP"

  local REPO=$(pacman -Si "$PKG" 2> /dev/null | grep ^Repository | awk '{print $NF}')
  local ARCH=$(pacman -Si "$PKG" 2> /dev/null | grep ^Architecture | awk '{print $NF}')
  arge testing && REPO=testing

  local GIT_REPO=packages
  [ $REPO == 'community' -o $REPO == 'multilib' ] && GIT_REPO=community

  local GIT_PKG_PATH="repos/$REPO-$ARCH"
  arge trunk:k && GIT_PKG_PATH="$PKG/trunk"

  msg "fetching $REPO/$PKG"
  if ! git clone "$GIT_URL/$GIT_REPO.git" --single-branch -b packages/"$PKG"; then
    warn 'Git fetch failed'
    return
  fi

  [ -d "$ABS_DEVEL/$PKG" ] && warn "path $ABS_DEVEL/$PKG already exists"
  cp -r "$GIT_REPO/$GIT_PKG_PATH" "$ABS_DEVEL/$PKG"
  cd "$ABS_DEVEL/$PKG"
  arge pkgbuild || makepkg -ors --noconfirm

  msg "$REPO/$PKG sources ready in ${ABS_DEVEL#$HOME/}/$PKG"
}

getAurPkgbuild() {
  local PKG=$1
  local TMP=$(tmpdir "$PKG")
  cd "$TMP"

  local TAR_URL=$(curl -LfGs --data-urlencode "arg=$PKG" "$AUR_RPC=info" | jq -r .results[0].URLPath)
  if [ -z "$TAR_URL" -o "$TAR_URL" == 'null' ]; then
    err "$PKG not found in AUR"
    return
  fi

  msg "fetching aur/$PKG"
  local TAR_FILE=$(basename "$TAR_URL")
  wget -q "${AUR_URL}${TAR_URL}" -O "$TAR_FILE"
  tar xfvz "$TAR_FILE" -C "$AUR_DEVEL"
  cd "$AUR_DEVEL/$PKG"

  arge pkgbuild || makepkg -ors --noconfirm
  msg "aur/$PKG sources ready in ${AUR_DEVEL#$HOME/}/$PKG"
}

for PKG in $(nfargs); do
  [ "$PKG" != "$(fnfarg)" ] && echo
  pacman -Si "$PKG" &> /dev/null && getAbsPkgbuild "$PKG" || getAurPkgbuild "$PKG"
done

tmpdirclean
