#!/bin/bash

source $(dirname "${BASH_SOURCE[0]}")/abash/abash.sh
[ $# -ge 1 ] || usage 'PACKAGE [PACKAGE ...]'

GNUPGHOME=/etc/pacman.d/gnupg

ABSDEVEL=$HOME/devel/arch/abs
AURDEVEL=$HOME/devel/arch/aur

AUR_DOMAIN=aur.archlinux.org
AUR_VERSION=5

SVN="svn://svn.archlinux.org"
AUR="https://${AUR_DOMAIN}"
RPC="https://${AUR_DOMAIN}/rpc.php?v=${AUR_VERSION}&type"

function getFromAUR {
  PACKAGE="$1"
  local TMP=$(tmpdir $PACKAGE)

  AURPKG=${TMP}/${PACKAGE}.tar.gz

  TAR=$(curl -LfGs --data-urlencode "arg=${PACKAGE}" "${RPC}=info" | jshon -Q -e results -a -e URLPath -u)
  if [ ! -z ${TAR} ]; then
    msg "${PACKAGE} found in AUR"
    /usr/bin/wget -q "${AUR}${TAR}" -O ${AURPKG}
    /bin/tar xfvz ${AURPKG} -C ${AURDEVEL}
    cd ${AURDEVEL}/${PACKAGE}

    arge pkgbuild || makepkg -ors --noconfirm
    msg "${PACKAGE} package ready in ${AURDEVEL}/${PACKAGE}"
  else
    err "${PACKAGE} not found in AUR"
  fi
}

function getPKGBUILD {
  PACKAGE="$1"
  local TMP=$(tmpdir $PACKAGE)

  # get repository given a package name
  REPO=$(/usr/bin/pacman -Si "${PACKAGE}" 2> /dev/null | egrep ^Repository | sed -e s/^.*\:\\s*//g)
  arge testing && REPO='testing'

  if [ -z ${REPO} ]; then
    warn "${PACKAGE} not found in any known repository"
    getFromAUR ${PACKAGE}
    return
  fi

  if [ ${REPO} = "community" -o $REPO = "multilib" ]; then
    SVNPKG="${SVN}/community"
  else
    SVNPKG="${SVN}/packages"
  fi

  msg "checking out ${PACKAGE} from subversion"
  /usr/bin/svn co --depth=empty ${SVNPKG} ${TMP}
  cd ${TMP}

  /usr/bin/svn up ${PACKAGE}
  PKGDIR=${TMP}/${PACKAGE}/repos/${REPO}-${HOSTTYPE}
  if [ ! -f ${PKGDIR}/PKGBUILD ]; then
    PKGDIR=${TMP}/${PACKAGE}/repos/${REPO}-any
  fi
  [ ! -f ${PKGDIR}/PKGBUILD ] && warn "subversion checkout failed"

  [ -d ${ABSDEVEL}/${PACKAGE} ] && warn "path ${ABSDEVEL}/${PACKAGE} already exists"

  cp -r ${PKGDIR} ${ABSDEVEL}/${PACKAGE}
  cd ${ABSDEVEL}/${PACKAGE}

  arge pkgbuild || makepkg -ors --noconfirm
  msg "${REPO}/${PACKAGE} package ready in ${ABSDEVEL}/${PACKAGE}"
}

if [ ! -d ${ABSDEVEL} ]; then
  warn "path ${ABSDEVEL} doesn't exist"
  mkdir -p ${ABSDEVEL}
fi

for PACKAGE in $(nfargs); do
  getPKGBUILD ${PACKAGE}
done

arge keep || tmpdirclean
